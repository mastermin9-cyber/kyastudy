<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KyaStudy - AI 채점</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .nav-tab-custom .nav-link { color: #6c757d; border: none; padding: 12px 24px; font-weight: 500; }
        .nav-tab-custom .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background: none; }
        .nav-tab-custom .nav-link:hover { color: #0d6efd; }

        .upload-zone { border: 2px dashed #dee2e6; border-radius: 16px; transition: all 0.2s; cursor: pointer; overflow: hidden; background: #fff; }
        .upload-zone:hover, .upload-zone.dragover { border-color: #0d6efd; background-color: #f0f4ff; }
        .upload-zone-inner { min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px; }
        .preview-area { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; }
        .preview-area:empty { display: none; }
        .preview-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #dee2e6; }

        .image-viewer { min-height: 450px; max-height: 75vh; overflow: auto; display: flex; align-items: center; justify-content: center; background: #e9ecef; border-radius: 8px; }
        .viewer-img { display: none; max-width: 100%; max-height: 70vh; }
        .viewer-img.active { display: block; }

        .section { display: none; }
        .section.active { display: block; }

        .score-bar { font-size: 1.3rem; padding: 10px 20px; border-radius: 12px; }

        .todo-item:hover { background-color: #f8f9fa; }
        .todo-done { text-decoration: line-through; color: #adb5bd; }
        .history-card:hover { background-color: #e9ecef; }

        /* AI Result */
        .result-card { border-radius: 12px; transition: all 0.15s; }
        .result-correct { border-left: 4px solid #198754; }
        .result-wrong { border-left: 4px solid #dc3545; }
        .explanation-box { background: #fff3cd; border-radius: 8px; padding: 12px 16px; margin-top: 8px; font-size: 0.95rem; }

        /* Loading */
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff;
        }
        .loading-overlay.d-none { display: none !important; }
        .spinner-lg { width: 60px; height: 60px; }

        /* API Key */
        .api-key-box { background: #e8f4fd; border: 1px solid #b6d4fe; border-radius: 12px; padding: 20px; }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay d-none" id="loadingOverlay">
    <div class="spinner-border spinner-lg text-light mb-3" role="status"></div>
    <h4>AI가 채점 중입니다...</h4>
    <p class="text-light opacity-75" id="loadingStatus">이미지를 분석하고 있습니다</p>
</div>

<!-- Navbar -->
<nav class="navbar navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#" onclick="showSection('upload')">
            <i class="bi bi-pencil-square"></i> KyaStudy
        </a>
        <button class="btn btn-outline-light btn-sm" onclick="showSection('settings')">
            <i class="bi bi-gear"></i> API 설정
        </button>
    </div>
</nav>

<!-- Tabs -->
<div class="bg-white border-bottom mb-4">
    <div class="container">
        <ul class="nav nav-tab-custom">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-section="upload"><i class="bi bi-robot"></i> AI 채점</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="todo"><i class="bi bi-check2-square"></i> To-Do</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="history"><i class="bi bi-clock-history"></i> 기록</a>
            </li>
        </ul>
    </div>
</div>

<div class="container pb-5">

    <!-- ==================== SETTINGS ==================== -->
    <div class="section" id="section-settings">
        <h3 class="mb-4"><i class="bi bi-gear"></i> API 설정</h3>
        <div class="api-key-box">
            <h5><i class="bi bi-key"></i> Google Gemini API Key</h5>
            <p class="text-muted small mb-3">
                무료 API 키는
                <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>
                에서 발급받을 수 있습니다.
            </p>
            <div class="input-group mb-3">
                <input type="password" class="form-control" id="apiKeyInput" placeholder="API 키를 입력하세요...">
                <button class="btn btn-outline-secondary" onclick="toggleKeyVisibility()">
                    <i class="bi bi-eye" id="eyeIcon"></i>
                </button>
            </div>

            <h6 class="mt-3"><i class="bi bi-cpu"></i> 모델 선택</h6>
            <select class="form-select mb-3" id="modelSelect">
                <option value="gemini-2.5-flash">Gemini 2.5 Flash (추천)</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro (정확도 높음, 할당량 적음)</option>
                <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite</option>
                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
            </select>

            <button class="btn btn-primary" onclick="saveApiKey()"><i class="bi bi-save"></i> 저장</button>
            <span class="ms-2 text-success d-none" id="apiSaveMsg"><i class="bi bi-check-circle"></i> 저장됨</span>
        </div>
        <div class="mt-3">
            <button class="btn btn-outline-secondary" onclick="showSection('upload')"><i class="bi bi-arrow-left"></i> 돌아가기</button>
        </div>
    </div>

    <!-- ==================== UPLOAD ==================== -->
    <div class="section active" id="section-upload">
        <h3 class="mb-4"><i class="bi bi-robot"></i> AI 자동 채점</h3>

        <!-- API Key Warning -->
        <div class="alert alert-warning d-none" id="noKeyWarning">
            <i class="bi bi-exclamation-triangle"></i>
            API 키가 설정되지 않았습니다.
            <a href="#" onclick="showSection('settings')">설정하기</a>
        </div>

        <div class="mb-3">
            <input type="text" class="form-control form-control-lg" id="sessionTitle" placeholder="제목 (예: 수학 3단원)">
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="upload-zone" id="problemZone">
                    <div class="upload-zone-inner">
                        <i class="bi bi-journal-text display-3 text-primary"></i>
                        <h5 class="mt-3 mb-1">문제집 (풀은 사진)</h5>
                        <p class="text-muted small mb-0">클릭 또는 드래그앤드롭</p>
                        <p class="text-muted small">여러 장 선택 가능</p>
                        <input type="file" id="problemInput" multiple accept="image/*" class="d-none">
                    </div>
                    <div id="problemPreview" class="preview-area"></div>
                </div>
                <div class="text-center mt-2"><span class="badge bg-primary" id="problemCount">0장</span></div>
            </div>
            <div class="col-md-6">
                <div class="upload-zone" id="answerZone">
                    <div class="upload-zone-inner">
                        <i class="bi bi-journal-check display-3 text-success"></i>
                        <h5 class="mt-3 mb-1">해답지</h5>
                        <p class="text-muted small mb-0">클릭 또는 드래그앤드롭</p>
                        <p class="text-muted small">여러 장 선택 가능</p>
                        <input type="file" id="answerInput" multiple accept="image/*" class="d-none">
                    </div>
                    <div id="answerPreview" class="preview-area"></div>
                </div>
                <div class="text-center mt-2"><span class="badge bg-success" id="answerCount">0장</span></div>
            </div>
        </div>

        <div class="text-center">
            <button class="btn btn-primary btn-lg px-5" id="startBtn" disabled onclick="startAIGrading()">
                <i class="bi bi-robot"></i> AI 채점 시작
            </button>
        </div>
    </div>

    <!-- ==================== RESULT ==================== -->
    <div class="section" id="section-result">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h3 id="resultTitle"><i class="bi bi-clipboard-check"></i> 채점 결과</h3>
            <span class="score-bar bg-dark text-white" id="resultScore">0 / 0</span>
        </div>

        <!-- 점수 요약 -->
        <div class="card mb-4">
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-4">
                        <h2 class="text-primary mb-0" id="summaryTotal">0</h2>
                        <small class="text-muted">총 문제</small>
                    </div>
                    <div class="col-4">
                        <h2 class="text-success mb-0" id="summaryCorrect">0</h2>
                        <small class="text-muted">정답</small>
                    </div>
                    <div class="col-4">
                        <h2 class="text-danger mb-0" id="summaryWrong">0</h2>
                        <small class="text-muted">오답</small>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar bg-success" id="scoreBar" style="width: 0%"></div>
                </div>
                <p class="mt-2 mb-0 fw-bold fs-5" id="scorePercent">0%</p>
            </div>
        </div>

        <!-- 이미지 뷰어 -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between">
                        <span><i class="bi bi-journal-text"></i> 문제집</span>
                        <span id="rProblemPageInfo">0 / 0</span>
                    </div>
                    <div class="card-body image-viewer" id="rProblemViewer"></div>
                    <div class="card-footer text-center">
                        <button class="btn btn-sm btn-outline-secondary" onclick="navImg('rProblem',-1)"><i class="bi bi-chevron-left"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="navImg('rProblem',1)"><i class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between">
                        <span><i class="bi bi-journal-check"></i> 해답지</span>
                        <span id="rAnswerPageInfo">0 / 0</span>
                    </div>
                    <div class="card-body image-viewer" id="rAnswerViewer"></div>
                    <div class="card-footer text-center">
                        <button class="btn btn-sm btn-outline-secondary" onclick="navImg('rAnswer',-1)"><i class="bi bi-chevron-left"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="navImg('rAnswer',1)"><i class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 문제별 결과 -->
        <h5 class="mb-3"><i class="bi bi-list-check"></i> 문제별 결과</h5>
        <div id="resultList"></div>

        <!-- 틀린 문제 해설 -->
        <div class="d-none" id="wrongSection">
            <h5 class="mt-4 mb-3 text-danger"><i class="bi bi-x-circle"></i> 틀린 문제 해설</h5>
            <div id="wrongList"></div>
        </div>

        <div class="text-center mt-4">
            <button class="btn btn-primary btn-lg px-4" onclick="saveResultToHistory()"><i class="bi bi-save"></i> 기록 저장</button>
            <button class="btn btn-outline-secondary btn-lg px-4 ms-2" onclick="showSection('upload')"><i class="bi bi-arrow-left"></i> 새 채점</button>
        </div>
    </div>

    <!-- ==================== TODO ==================== -->
    <div class="section" id="section-todo">
        <h3 class="mb-4"><i class="bi bi-check2-square"></i> To-Do 리스트</h3>
        <div class="input-group mb-4">
            <input type="text" class="form-control form-control-lg" id="todoInput" placeholder="할 일을 입력하세요..." maxlength="500">
            <button class="btn btn-primary btn-lg" onclick="addTodo()"><i class="bi bi-plus-lg"></i> 추가</button>
        </div>
        <div id="todoList"></div>
        <div class="text-center text-muted py-5" id="todoEmpty">
            <i class="bi bi-inbox display-1"></i>
            <p class="mt-3">할 일이 없습니다</p>
        </div>
    </div>

    <!-- ==================== HISTORY ==================== -->
    <div class="section" id="section-history">
        <h3 class="mb-4"><i class="bi bi-clock-history"></i> 이전 채점 기록</h3>
        <div id="historyList"></div>
        <div class="text-center text-muted py-5" id="historyEmpty">
            <i class="bi bi-inbox display-1"></i>
            <p class="mt-3">채점 기록이 없습니다</p>
        </div>
    </div>

</div>

<script>
// ===== State =====
let problemFiles = [];
let answerFiles = [];
let problemDataUrls = [];
let answerDataUrls = [];
let imgIndexes = { rProblem: 0, rAnswer: 0 };
let lastAIResult = null;

// ===== API Key & Model =====
function getApiKey() { return localStorage.getItem('kyastudy_gemini_key') || ''; }
function getModel() { return localStorage.getItem('kyastudy_model') || 'gemini-2.5-flash'; }
function saveApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    const model = document.getElementById('modelSelect').value;
    localStorage.setItem('kyastudy_gemini_key', key);
    localStorage.setItem('kyastudy_model', model);
    document.getElementById('apiSaveMsg').classList.remove('d-none');
    setTimeout(() => document.getElementById('apiSaveMsg').classList.add('d-none'), 2000);
    checkApiKey();
}
function toggleKeyVisibility() {
    const input = document.getElementById('apiKeyInput');
    const icon = document.getElementById('eyeIcon');
    if (input.type === 'password') { input.type = 'text'; icon.className = 'bi bi-eye-slash'; }
    else { input.type = 'password'; icon.className = 'bi bi-eye'; }
}
function checkApiKey() {
    const hasKey = getApiKey().length > 0;
    document.getElementById('noKeyWarning').classList.toggle('d-none', hasKey);
}

// ===== Image Compression =====
function compressImage(dataUrl, maxWidth = 1024, quality = 0.7) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.src = dataUrl;
    });
}

// ===== Tab Navigation =====
document.querySelectorAll('[data-section]').forEach(tab => {
    tab.addEventListener('click', e => { e.preventDefault(); showSection(tab.dataset.section); });
});
function showSection(name) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-' + name).classList.add('active');
    document.querySelectorAll('[data-section]').forEach(t => t.classList.remove('active'));
    const activeTab = document.querySelector('[data-section="' + name + '"]');
    if (activeTab) activeTab.classList.add('active');
    if (name === 'todo') renderTodos();
    if (name === 'history') renderHistory();
    if (name === 'settings') { document.getElementById('apiKeyInput').value = getApiKey(); document.getElementById('modelSelect').value = getModel(); }
    if (name === 'upload') checkApiKey();
}

// ===== Upload Zones =====
function setupZone(zoneId, inputId, previewId, countId, type) {
    const zone = document.getElementById(zoneId);
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    zone.addEventListener('click', e => { if (!e.target.closest('.preview-thumb')) input.click(); });
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', e => {
        e.preventDefault(); zone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files, type, preview, countId);
    });
    input.addEventListener('change', () => handleFiles(input.files, type, preview, countId));
}
function handleFiles(fileList, type, preview, countId) {
    const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
    if (type === 'problem') problemFiles = files; else answerFiles = files;
    preview.innerHTML = '';
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
            const img = document.createElement('img');
            img.src = e.target.result; img.className = 'preview-thumb';
            preview.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
    document.getElementById(countId).textContent = files.length + '장';
    document.getElementById('startBtn').disabled = !(problemFiles.length > 0 && answerFiles.length > 0);
}
setupZone('problemZone', 'problemInput', 'problemPreview', 'problemCount', 'problem');
setupZone('answerZone', 'answerInput', 'answerPreview', 'answerCount', 'answer');

// ===== AI Grading =====
async function startAIGrading() {
    const apiKey = getApiKey();
    if (!apiKey) { showSection('settings'); alert('Gemini API 키를 먼저 설정해주세요.'); return; }
    if (problemFiles.length === 0 || answerFiles.length === 0) return;

    showLoading(true, '이미지를 읽고 있습니다...');

    // Read all files as base64
    try {
        problemDataUrls = await readAllFiles(problemFiles);
        answerDataUrls = await readAllFiles(answerFiles);
    } catch (err) {
        showLoading(false);
        alert('이미지 읽기 실패: ' + err.message);
        return;
    }

    showLoading(true, '이미지를 압축하고 있습니다...');

    // Compress images to reduce token usage
    try {
        const compressedProblems = await Promise.all(problemDataUrls.map(u => compressImage(u)));
        const compressedAnswers = await Promise.all(answerDataUrls.map(u => compressImage(u)));
        problemDataUrls = compressedProblems;
        answerDataUrls = compressedAnswers;
    } catch (e) { /* use originals if compression fails */ }

    showLoading(true, 'AI가 문제와 해답을 분석 중입니다...');

    // Build Gemini request
    const imageParts = [];

    problemDataUrls.forEach((url, i) => {
        imageParts.push({ text: `[학생 답안 이미지 ${i + 1}]` });
        imageParts.push({ inline_data: { mime_type: 'image/jpeg', data: getBase64(url) } });
    });

    answerDataUrls.forEach((url, i) => {
        imageParts.push({ text: `[해답지 이미지 ${i + 1}]` });
        imageParts.push({ inline_data: { mime_type: 'image/jpeg', data: getBase64(url) } });
    });

    const prompt = `너는 시험 채점 전문가야. 위 이미지들을 분석해서 채점해줘.

[학생 답안 이미지]는 학생이 풀어서 작성한 답안이고,
[해답지 이미지]는 정답이 적혀있는 해답지야.

다음을 수행해줘:
1. 해답지에서 각 문제의 정답을 읽어줘
2. 학생 답안에서 학생이 작성한 답을 읽어줘
3. 각 문제별로 학생 답과 정답을 비교해서 채점해줘
4. 틀린 문제는 왜 틀렸는지 간단히 설명해줘 (학생이 어떤 실수를 했는지, 올바른 풀이 방향은 무엇인지)

반드시 아래 JSON 형식으로만 응답해줘 (다른 텍스트 없이 순수 JSON만):
{
  "results": [
    {
      "number": 1,
      "student_answer": "학생이 쓴 답",
      "correct_answer": "정답",
      "is_correct": true,
      "explanation": ""
    },
    {
      "number": 2,
      "student_answer": "학생이 쓴 답",
      "correct_answer": "정답",
      "is_correct": false,
      "explanation": "틀린 이유와 올바른 풀이 방향 설명"
    }
  ]
}

- 답을 읽을 수 없는 경우 student_answer를 "판독 불가"로 적어줘
- explanation은 틀린 문제만 작성해줘 (맞은 문제는 빈 문자열)
- 풀이 과정이 보이면 풀이 과정도 고려해서 어디서 실수했는지 알려줘`;

    const requestBody = {
        contents: [{
            parts: [{ text: prompt }, ...imageParts]
        }],
        generationConfig: {
            temperature: 0.1,
            maxOutputTokens: 8192,
            responseMimeType: "application/json",
            responseSchema: {
                type: "object",
                properties: {
                    results: {
                        type: "array",
                        items: {
                            type: "object",
                            properties: {
                                number: { type: "integer" },
                                student_answer: { type: "string" },
                                correct_answer: { type: "string" },
                                is_correct: { type: "boolean" },
                                explanation: { type: "string" }
                            },
                            required: ["number", "student_answer", "correct_answer", "is_correct", "explanation"]
                        }
                    }
                },
                required: ["results"]
            }
        }
    };

    try {
        showLoading(true, 'AI가 채점 결과를 생성 중입니다...');

        const model = getModel();
        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            }
        );

        if (!response.ok) {
            const errData = await response.json().catch(() => ({}));
            const errMsg = errData.error?.message || '';
            if (errMsg.includes('quota') || errMsg.includes('rate-limit') || response.status === 429) {
                throw new Error('API 할당량 초과입니다.\n\n해결 방법:\n1. API 설정에서 다른 모델로 변경해보세요\n2. 1~2분 후 다시 시도해보세요\n3. Google AI Studio에서 할당량을 확인하세요');
            }
            if (response.status === 400) {
                throw new Error('요청 오류: 이미지가 너무 크거나 형식이 올바르지 않습니다.\n이미지 수를 줄여서 다시 시도해보세요.');
            }
            if (response.status === 403) {
                throw new Error('API 키가 올바르지 않습니다. API 설정에서 키를 확인해주세요.');
            }
            throw new Error(errMsg || `API 오류 (${response.status})`);
        }

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        if (!text) throw new Error('AI 응답이 비어있습니다. 다시 시도해주세요.');

        // Parse JSON - clean up common issues
        let jsonStr = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        let parsed;
        try {
            parsed = JSON.parse(jsonStr);
        } catch (e1) {
            // Try fixing: remove control chars inside strings
            jsonStr = jsonStr.replace(/[\x00-\x1f]/g, m => m === '\n' || m === '\t' ? ' ' : '');
            try { parsed = JSON.parse(jsonStr); } catch (e2) {
                // Last resort: extract JSON object
                const match = jsonStr.match(/\{[\s\S]*\}/);
                if (match) {
                    const fixed = match[0].replace(/[\x00-\x1f]/g, ' ');
                    parsed = JSON.parse(fixed);
                } else { throw e1; }
            }
        }

        lastAIResult = parsed;
        showLoading(false);
        displayResults(parsed);

    } catch (err) {
        showLoading(false);
        console.error('AI Grading Error:', err);
        alert('AI 채점 실패:\n\n' + err.message);
    }
}

function readAllFiles(files) {
    return Promise.all(files.map(file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = () => reject(new Error('파일 읽기 실패'));
        reader.readAsDataURL(file);
    })));
}

function getMime(dataUrl) {
    const match = dataUrl.match(/^data:(.*?);/);
    return match ? match[1] : 'image/jpeg';
}

function getBase64(dataUrl) {
    return dataUrl.split(',')[1];
}

function showLoading(show, msg) {
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
        overlay.classList.remove('d-none');
        if (msg) document.getElementById('loadingStatus').textContent = msg;
    } else {
        overlay.classList.add('d-none');
    }
}

// ===== Display Results =====
function displayResults(parsed) {
    const results = parsed.results || [];
    const title = document.getElementById('sessionTitle').value || '채점';
    document.getElementById('resultTitle').innerHTML = '<i class="bi bi-clipboard-check"></i> ' + title;

    // Summary
    const total = results.length;
    const correct = results.filter(r => r.is_correct).length;
    const wrong = total - correct;
    const pct = total > 0 ? Math.round(correct / total * 100) : 0;

    document.getElementById('summaryTotal').textContent = total;
    document.getElementById('summaryCorrect').textContent = correct;
    document.getElementById('summaryWrong').textContent = wrong;
    document.getElementById('resultScore').textContent = correct + ' / ' + total;
    document.getElementById('scoreBar').style.width = pct + '%';
    document.getElementById('scorePercent').textContent = pct + '%';

    // Build image viewers
    buildViewer('rProblemViewer', problemDataUrls, 'rProblemPageInfo', 'rProblem');
    buildViewer('rAnswerViewer', answerDataUrls, 'rAnswerPageInfo', 'rAnswer');

    // Result list
    const listEl = document.getElementById('resultList');
    listEl.innerHTML = results.map(r => `
        <div class="card mb-2 result-card ${r.is_correct ? 'result-correct' : 'result-wrong'}">
            <div class="card-body py-2 px-3 d-flex align-items-center gap-3">
                <span class="fw-bold" style="min-width:40px">${r.number}번</span>
                <span class="badge ${r.is_correct ? 'bg-success' : 'bg-danger'}">${r.is_correct ? '정답' : '오답'}</span>
                <span class="text-muted small">학생: <strong>${escapeHtml(r.student_answer)}</strong></span>
                ${!r.is_correct ? `<span class="text-muted small">정답: <strong class="text-success">${escapeHtml(r.correct_answer)}</strong></span>` : ''}
            </div>
        </div>
    `).join('');

    // Wrong explanations
    const wrongResults = results.filter(r => !r.is_correct && r.explanation);
    const wrongSection = document.getElementById('wrongSection');
    const wrongList = document.getElementById('wrongList');

    if (wrongResults.length > 0) {
        wrongSection.classList.remove('d-none');
        wrongList.innerHTML = wrongResults.map(r => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="badge bg-danger">${r.number}번</span>
                        <span class="text-muted">학생 답: <strong>${escapeHtml(r.student_answer)}</strong></span>
                        <i class="bi bi-arrow-right text-muted"></i>
                        <span class="text-success">정답: <strong>${escapeHtml(r.correct_answer)}</strong></span>
                    </div>
                    <div class="explanation-box">
                        <i class="bi bi-lightbulb text-warning"></i> ${escapeHtml(r.explanation)}
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        wrongSection.classList.add('d-none');
    }

    showSection('result');
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function buildViewer(viewerId, urls, pageInfoId, key) {
    const viewer = document.getElementById(viewerId);
    viewer.innerHTML = '';
    imgIndexes[key] = 0;
    urls.forEach((url, i) => {
        const img = document.createElement('img');
        img.src = url;
        img.className = 'viewer-img' + (i === 0 ? ' active' : '');
        viewer.appendChild(img);
    });
    document.getElementById(pageInfoId).textContent = urls.length > 0 ? '1 / ' + urls.length : '0 / 0';
}

function navImg(key, dir) {
    const viewer = document.getElementById(key + 'Viewer');
    const imgs = viewer.querySelectorAll('.viewer-img');
    if (imgs.length === 0) return;
    imgs[imgIndexes[key]].classList.remove('active');
    imgIndexes[key] = Math.max(0, Math.min(imgs.length - 1, imgIndexes[key] + dir));
    imgs[imgIndexes[key]].classList.add('active');
    document.getElementById(key + 'PageInfo').textContent = (imgIndexes[key] + 1) + ' / ' + imgs.length;
}

// ===== Save to History =====
function saveResultToHistory() {
    if (!lastAIResult) return;
    const results = lastAIResult.results || [];
    const total = results.length;
    const correct = results.filter(r => r.is_correct).length;
    const title = document.getElementById('sessionTitle').value || '채점';

    const record = {
        id: Date.now(),
        title: title,
        date: new Date().toLocaleString('ko-KR'),
        total: total,
        correct: correct,
        results: results
    };

    const history = JSON.parse(localStorage.getItem('kyastudy_history') || '[]');
    history.unshift(record);
    localStorage.setItem('kyastudy_history', JSON.stringify(history));
    alert('저장 완료! ' + correct + '/' + total + ' (' + Math.round(correct/total*100) + '%)');
}

// ===== Todo =====
function getTodos() { return JSON.parse(localStorage.getItem('kyastudy_todos') || '[]'); }
function saveTodosData(todos) { localStorage.setItem('kyastudy_todos', JSON.stringify(todos)); }

function addTodo() {
    const input = document.getElementById('todoInput');
    const text = input.value.trim();
    if (!text) return;
    const todos = getTodos();
    todos.unshift({ id: Date.now(), content: text, done: false, date: new Date().toLocaleDateString('ko-KR') });
    saveTodosData(todos);
    input.value = '';
    renderTodos();
}
document.getElementById('todoInput').addEventListener('keydown', e => { if (e.key === 'Enter') addTodo(); });

function toggleTodo(id) {
    const todos = getTodos();
    const t = todos.find(x => x.id === id);
    if (t) t.done = !t.done;
    saveTodosData(todos);
    renderTodos();
}
function deleteTodo(id) {
    saveTodosData(getTodos().filter(x => x.id !== id));
    renderTodos();
}
function renderTodos() {
    const todos = getTodos();
    const list = document.getElementById('todoList');
    const empty = document.getElementById('todoEmpty');
    if (todos.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; return; }
    empty.style.display = 'none';
    list.innerHTML = todos.map(t => `
        <div class="list-group-item d-flex align-items-center gap-2">
            <button class="btn btn-sm ${t.done ? 'btn-success' : 'btn-outline-secondary'}" onclick="toggleTodo(${t.id})">
                <i class="bi bi-${t.done ? 'check-lg' : 'circle'}"></i>
            </button>
            <span class="flex-grow-1 ${t.done ? 'todo-done' : ''}">${escapeHtml(t.content)}</span>
            <span class="text-muted small">${t.date}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteTodo(${t.id})"><i class="bi bi-x-lg"></i></button>
        </div>
    `).join('');
}

// ===== History =====
function renderHistory() {
    const history = JSON.parse(localStorage.getItem('kyastudy_history') || '[]');
    const list = document.getElementById('historyList');
    const empty = document.getElementById('historyEmpty');
    if (history.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; return; }
    empty.style.display = 'none';
    list.innerHTML = history.map((h, i) => {
        const pct = h.total > 0 ? Math.round(h.correct / h.total * 100) : 0;
        const color = pct >= 80 ? 'success' : (pct >= 50 ? 'warning' : 'danger');
        return `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <strong>${escapeHtml(h.title)}</strong>
                <span class="text-muted ms-2 small">${h.date}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-${color} fs-6">${h.correct}/${h.total} (${pct}%)</span>
                ${h.results ? `<button class="btn btn-sm btn-outline-primary" onclick="viewHistoryDetail(${i})"><i class="bi bi-eye"></i></button>` : ''}
                <button class="btn btn-sm btn-outline-danger" onclick="deleteHistory(${i})"><i class="bi bi-trash"></i></button>
            </div>
        </div>`;
    }).join('');
}

function viewHistoryDetail(index) {
    const history = JSON.parse(localStorage.getItem('kyastudy_history') || '[]');
    const h = history[index];
    if (!h || !h.results) return;
    lastAIResult = { results: h.results };
    document.getElementById('sessionTitle').value = h.title;
    problemDataUrls = [];
    answerDataUrls = [];
    displayResults(lastAIResult);
}

function deleteHistory(index) {
    if (!confirm('삭제하시겠습니까?')) return;
    const history = JSON.parse(localStorage.getItem('kyastudy_history') || '[]');
    history.splice(index, 1);
    localStorage.setItem('kyastudy_history', JSON.stringify(history));
    renderHistory();
}

// ===== Init =====
checkApiKey();
renderTodos();
</script>
</body>
</html>
